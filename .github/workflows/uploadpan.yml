name: Sync Existing Releases to Cloudreve

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tag_name:
        description: 'è¦åŒæ­¥çš„ç‰¹å®šæ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰ï¼Œç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰ç‰ˆæœ¬'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (for utility scripts if needed)
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Get all releases
        id: get-releases
        run: |
          # è·å–ä»“åº“çš„æ‰€æœ‰releaseä¿¡æ¯
          response=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          
          echo "releases_json=$(echo $response | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Sync releases to Cloudreve
        run: |
          RELEASES_JSON='${{ steps.get-releases.outputs.releases_json }}'
          SPECIFIC_TAG='${{ github.event.inputs.tag_name }}'

          # éå†æ‰€æœ‰release
          echo "$RELEASES_JSON" | jq -c '.[]' | while read release; do
            tag_name=$(echo "$release" | jq -r '.tag_name')
            release_id=$(echo "$release" | jq -r '.id')
            release_name=$(echo "$release" | jq -r '.name')
            
            # å¦‚æœæŒ‡å®šäº†ç‰¹å®šæ ‡ç­¾ï¼Œåªå¤„ç†è¯¥æ ‡ç­¾
            if [ -n "$SPECIFIC_TAG" ] && [ "$tag_name" != "$SPECIFIC_TAG" ]; then
              echo "è·³è¿‡ $tag_name ($release_name)ï¼Œä¸æ˜¯æŒ‡å®šçš„æ ‡ç­¾ $SPECIFIC_TAG"
              continue
            fi

            echo "æ­£åœ¨å¤„ç†ç‰ˆæœ¬: $tag_name ($release_name, ID: $release_id)"

            # è·å–è¯¥releaseçš„æ‰€æœ‰èµ„æºæ–‡ä»¶
            assets=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets")

            # æ£€æŸ¥assetsæ˜¯å¦ä¸ºç©ºæˆ–æ— æ•ˆ
            if [ -z "$assets" ] || [ "$assets" = "null" ] || [ "$(echo "$assets" | jq 'length')" -eq 0 ]; then
              echo "ç‰ˆæœ¬ $tag_name æ²¡æœ‰èµ„æºæ–‡ä»¶ï¼Œè·³è¿‡"
              continue
            fi

            # éå†æ‰€æœ‰èµ„æºæ–‡ä»¶
            echo "$assets" | jq -c '.[]' | while read asset; do
              asset_name=$(echo "$asset" | jq -r '.name')
              asset_url=$(echo "$asset" | jq -r '.url')
              asset_size=$(echo "$asset" | jq -r '.size')
              browser_download_url=$(echo "$asset" | jq -r '.browser_download_url')
              
              echo "ä¸‹è½½èµ„æº: $asset_name (å¤§å°: $(($asset_size/1024/1024))MB)"
              
              # ä¸‹è½½èµ„æºæ–‡ä»¶ï¼Œæ·»åŠ è¶…æ—¶è®¾ç½®
              if curl -sL --connect-timeout 30 --max-time 600 -o "$asset_name" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/octet-stream" \
                "$asset_url"; then
                
                if [ -f "$asset_name" ]; then
                  file_size=$(stat -c%s "$asset_name")
                  echo "ä¸‹è½½æˆåŠŸ: $asset_name (æœ¬åœ°å¤§å°: $(($file_size/1024/1024))MB)"
                  
                  # åˆ›å»ºç‰ˆæœ¬ç›®å½•ï¼ˆå¦‚æœWebDAVæ”¯æŒMKCOLï¼‰
                  echo "åˆ›å»ºç›®å½•: $tag_name"
                  curl -X MKCOL --connect-timeout 30 --max-time 60 \
                    -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
                    "${{ secrets.WEBDAV_URL }}/$tag_name" 2>/dev/null || true
                  
                  # ä¸Šä¼ åˆ°Cloudreve WebDAVï¼ŒæŒ‰ç‰ˆæœ¬å·ç»„ç»‡ç›®å½•
                  echo "ä¸Šä¼ åˆ° Cloudreve: $asset_name"
                  
                  if curl --connect-timeout 30 --max-time 600 -T "$asset_name" \
                    -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
                    "${{ secrets.WEBDAV_URL }}/$tag_name/$asset_name"; then
                    
                    echo "ä¸Šä¼ æˆåŠŸ: $asset_name"
                  else
                    echo "ä¸Šä¼ å¤±è´¥: $asset_name"
                  fi
                  
                  # ä¿®å¤ï¼šå®‰å…¨åœ°åˆ é™¤å¯èƒ½ä»¥ç ´æŠ˜å·å¼€å¤´çš„æ–‡ä»¶
                  rm -- "$asset_name"
                  echo "å·²åˆ é™¤ä¸´æ—¶æ–‡ä»¶: $asset_name"
                else
                  echo "ä¸‹è½½å¤±è´¥: æ–‡ä»¶ $asset_name ä¸å­˜åœ¨"
                fi
              else
                echo "ä¸‹è½½å¤±è´¥: $asset_name (ç½‘ç»œè¶…æ—¶æˆ–é”™è¯¯)"
              fi
              echo "----------------------------------------"
            done
          done
          
          echo "åŒæ­¥å®Œæˆï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync completion status
        run: |
          echo "ğŸ‰ æ‰€æœ‰æŒ‡å®šçš„å‘å¸ƒç‰ˆæœ¬å·²åŒæ­¥åˆ° Cloudreve"
          echo "ğŸ“ WebDAV åœ°å€: ${{ secrets.WEBDAV_URL }}"

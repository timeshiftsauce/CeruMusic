name: Sync Existing Releases to WebDAV

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¦åŒæ­¥çš„ç‰¹å®šæ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰ï¼Œç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰ç‰ˆæœ¬'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  sync-releases-to-webdav:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: Get all releases
        id: get-releases
        run: |
          response=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          echo "releases_json=$(echo "$response" | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Sync releases to WebDAV
        run: |
          # è¯»å–è¾“å…¥å‚æ•°
          SPECIFIC_TAG="${{ github.event.inputs.tag_name }}"
          RELEASES_JSON='${{ steps.get-releases.outputs.releases_json }}'
          
          echo "å¼€å§‹åŒæ­¥ releases..."
          echo "ç‰¹å®šæ ‡ç­¾: ${SPECIFIC_TAG:-æ‰€æœ‰ç‰ˆæœ¬}"
          echo "WebDAV æ ¹è·¯å¾„: ${{ secrets.WEBDAV_BASE_URL }}/yd/ceru"

          # å¤„ç†æ¯ä¸ª release
          releases_count=$(echo "$RELEASES_JSON" | jq '. | length')
          echo "æ‰¾åˆ° $releases_count ä¸ª releases"

          for i in $(seq 0 $(($releases_count - 1))); do
            release=$(echo "$RELEASES_JSON" | jq -c ".[$i]")
            tag_name=$(echo "$release" | jq -r '.tag_name')
            release_id=$(echo "$release" | jq -r '.id')
            
            if [ -n "$SPECIFIC_TAG" ] && [ "$tag_name" != "$SPECIFIC_TAG" ]; then
              echo "è·³è¿‡ $tag_nameï¼Œä¸æ˜¯æŒ‡å®šçš„æ ‡ç­¾ $SPECIFIC_TAG"
              continue
            fi

            echo "æ­£åœ¨å¤„ç†ç‰ˆæœ¬: $tag_name (ID: $release_id)"

            # è·å–è¯¥releaseçš„æ‰€æœ‰èµ„æºæ–‡ä»¶
            assets_json=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets")

            assets_count=$(echo "$assets_json" | jq '. | length')
            echo "æ‰¾åˆ° $assets_count ä¸ªèµ„æºæ–‡ä»¶"

            # å¤„ç†æ¯ä¸ªasset
            for j in $(seq 0 $(($assets_count - 1))); do
              asset=$(echo "$assets_json" | jq -c ".[$j]")
              asset_name=$(echo "$asset" | jq -r '.name')
              asset_url=$(echo "$asset" | jq -r '.url')
              asset_size=$(echo "$asset" | jq -r '.size')
              
              echo "ä¸‹è½½èµ„æº: $asset_name (å¤§å°: $asset_size bytes)"

              # ä¸‹è½½èµ„æºæ–‡ä»¶
              safe_filename="./temp_download"
              
              if ! curl -sL -o "$safe_filename" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/octet-stream" \
                "$asset_url"; then
                echo "âŒ ä¸‹è½½å¤±è´¥: $asset_name"
                continue
              fi
              
              if [ -f "$safe_filename" ]; then
                actual_size=$(wc -c < "$safe_filename")
                if [ "$actual_size" -ne "$asset_size" ]; then
                  echo "âŒ æ–‡ä»¶å¤§å°ä¸åŒ¹é…: $asset_name (æœŸæœ›: $asset_size, å®é™…: $actual_size)"
                  rm -f "$safe_filename"
                  continue
                fi

                echo "ä¸Šä¼ åˆ° WebDAV: $asset_name"
                
                # æ„å»ºè¿œç¨‹è·¯å¾„
                remote_path="/yd/ceru/$tag_name/$asset_name"
                full_url="${{ secrets.WEBDAV_BASE_URL }}$remote_path"
                
                echo "å®Œæ•´è·¯å¾„: $full_url"
                
                # ä½¿ç”¨ WebDAV PUT æ–¹æ³•ä¸Šä¼ æ–‡ä»¶
                if curl -s -f -X PUT \
                  -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
                  -T "$safe_filename" \
                  "$full_url"; then
                  
                  echo "âœ… WebDAV ä¸Šä¼ æˆåŠŸ: $asset_name"
                  
                  # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                  echo "éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
                  sleep 2
                  
                  if curl -s -f -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
                    -X PROPFIND \
                    -H "Depth: 0" \
                    "$full_url" > /dev/null 2>&1; then
                    echo "âœ… æ–‡ä»¶ç¡®è®¤å­˜åœ¨: $asset_name"
                  else
                    echo "âš ï¸  æ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œä½†ä¸Šä¼ å¯èƒ½æˆåŠŸ"
                  fi
                  
                else
                  echo "âŒ WebDAV ä¸Šä¼ å¤±è´¥: $asset_name"
                  echo "å°è¯•åˆ›å»ºç›®å½•åé‡æ–°ä¸Šä¼ ..."
                  
                  # å°è¯•å…ˆåˆ›å»ºç›®å½•
                  dir_path="/yd/ceru/$tag_name"
                  dir_url="${{ secrets.WEBDAV_BASE_URL }}$dir_path"
                  
                  if curl -s -f -X MKCOL \
                    -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
                    "$dir_url"; then
                    echo "âœ… ç›®å½•åˆ›å»ºæˆåŠŸ: $dir_path"
                    
                    # é‡æ–°å°è¯•ä¸Šä¼ æ–‡ä»¶
                    if curl -s -f -X PUT \
                      -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
                      -T "$safe_filename" \
                      "$full_url"; then
                      echo "âœ… é‡æ–°ä¸Šä¼ æˆåŠŸ: $asset_name"
                    else
                      echo "âŒ é‡æ–°ä¸Šä¼ å¤±è´¥: $asset_name"
                    fi
                  else
                    echo "âŒ ç›®å½•åˆ›å»ºå¤±è´¥: $dir_path"
                  fi
                fi
                
                # å®‰å…¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶
                rm -f "$safe_filename"
                echo "----------------------------------------"
              else
                echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $safe_filename"
              fi
            done
          done
          
          echo "ğŸ‰ WebDAV åŒæ­¥å®Œæˆ"

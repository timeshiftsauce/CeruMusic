name: AutoBuild # 工作流的名称

permissions:
  contents: write # 给予写入仓库内容的权限

on:
  push:
    tags:
      - 'v*' # 当推送以v开头的标签时触发
  workflow_dispatch: # 允许手动点击按钮触发构建

jobs:
  release:
    name: build and release electron app
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # 即使一个平台失败，其他平台继续运行
      matrix:
        # 定义运行环境：Windows, macOS, Linux
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          # 【优化 1】启用 actions/setup-node 内置的 yarn 缓存
          # 它会根据 yarn.lock 自动管理 node_modules 的缓存
          cache: 'yarn'

      - name: Cache Electron Binaries
        # 【优化 2】缓存 Electron 预编译二进制文件
        # Electron 首次打包会下载很大的压缩包，缓存后下次构建可秒速跳过下载阶段
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-electron-v1-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-electron-v1-

      - name: Install Dependencies
        # 必须保留安装步骤，但由于有了上面的缓存，这一步会执行得非常快
        shell: bash
        run: |
          npm i -g yarn

          # Temporary fix for Windows: mock npx to bypass "only-allow pnpm" script failure
          if [ "${{ runner.os }}" == "Windows" ]; then
            mkdir -p .fake-bin
            echo '@echo off' > .fake-bin/npx.cmd
            echo 'echo "Fake npx called"' >> .fake-bin/npx.cmd
            export PATH="$PWD/.fake-bin:$PATH"
          fi

          yarn install --frozen-lockfile

      - name: Build Electron App for windows
        if: matrix.os == 'windows-latest'
        run: yarn run build:win

      - name: Build Electron App for macos
        if: matrix.os == 'macos-latest'
        run: yarn run build:mac:universal

      - name: Build Electron App for linux
        if: matrix.os == 'ubuntu-latest'
        run: yarn run build:linux

      - name: Cleanup Artifacts for Windows
        if: matrix.os == 'windows-latest'
        run: |
          npx del-cli "dist/*" "!dist/*.exe" "!dist/*.zip" "!dist/*.yml"

      - name: Cleanup Artifacts for MacOS
        if: matrix.os == 'macos-latest'
        run: |
          npx del-cli "dist/*" "!dist/(*.dmg|*.zip|latest*.yml)"

      - name: Cleanup Artifacts for Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          npx del-cli "dist/*" "!dist/(*.AppImage|*.deb|*.snap|latest*.yml)"

      - name: Upload Artifacts
        # 将构建产物上传到 GitHub Actions 任务面板，方便在 Release 发布前检查包体
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-build-artifacts
          path: dist

      - name: Release
        # 只有在推送 Tag (v*) 时才触发真正的 GitHub Release 发布
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: 'dist/**'
          body: ${{ github.event.head_commit.message }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

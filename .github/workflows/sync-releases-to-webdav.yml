name: Sync Existing Releases to Alist

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¦åŒæ­¥çš„ç‰¹å®šæ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰ï¼Œç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰ç‰ˆæœ¬'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  sync-releases-to-alist:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Get all releases
        id: get-releases
        run: |
          response=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          echo "releases_json=$(echo "$response" | jq -c '.')" >> $GITHUB_OUTPUT

      - name: Sync releases to Alistï¼ˆè‡ªåŠ¨ç™»å½• & ä¸Šä¼ ï¼‰
        run: |
          # ========== 1. è¯»å–è¾“å…¥å‚æ•° ==========
          SPECIFIC_TAG="${{ github.event.inputs.tag_name }}"
          RELEASES_JSON='${{ steps.get-releases.outputs.releases_json }}'

          # ========== 2. Alist è¿æ¥ä¿¡æ¯ ==========
          ALIST_URL="https://alist.shiqianjiang.cn"          # https://pan.example.com
          ALIST_USER="${{ secrets.WEBDAV_USERNAME }}"    # Alist ç™»å½•è´¦å·
          ALIST_PASS="${{ secrets.WEBDAV_PASSWORD }}"    # Alist ç™»å½•å¯†ç 
          ALIST_DIR="/yd/ceru"                          # ç›®æ ‡æ ¹ç›®å½•

          # ========== 3. ç™»å½•æ‹¿ token ==========
          echo "æ­£åœ¨ç™»å½• Alist ..."
          login_resp=$(curl -s -X POST "$ALIST_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d "{
                  \"username\": \"$ALIST_USER\",
                  \"password\": \"$ALIST_PASS\"
                }")
          echo "$login_resp"
          token=$(echo "$login_resp" | jq -r '.data.token // empty')

          if [ -z "$token" ]; then
            echo "âŒ ç™»å½•å¤±è´¥ï¼Œè¿”å›ï¼š$login_resp"
            exit 1
          fi
          echo "âœ… ç™»å½•æˆåŠŸï¼Œtoken å·²è·å–"

          # ========== 4. å¾ªç¯å¤„ç† release ==========
          releases_count=$(echo "$RELEASES_JSON" | jq '. | length')
          echo "æ‰¾åˆ° $releases_count ä¸ª releases"
          for i in $(seq 0 $(($releases_count - 1))); do
            release=$(echo "$RELEASES_JSON" | jq -c ".[$i]")
            tag_name=$(echo "$release" | jq -r '.tag_name')
            release_id=$(echo "$release" | jq -r '.id')

            [ -n "$SPECIFIC_TAG" ] && [ "$tag_name" != "$SPECIFIC_TAG" ] && {
              echo "è·³è¿‡ $tag_nameï¼Œä¸æ˜¯æŒ‡å®šæ ‡ç­¾"
              continue
            }

            echo "å¤„ç†ç‰ˆæœ¬: $tag_name (ID: $release_id)"
            assets_json=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets")
            assets_count=$(echo "$assets_json" | jq '. | length')
            echo "æ‰¾åˆ° $assets_count ä¸ªèµ„æºæ–‡ä»¶"

            for j in $(seq 0 $(($assets_count - 1))); do
              asset=$(echo "$assets_json" | jq -c ".[$j]")
              asset_name=$(echo "$asset" | jq -r '.name')
              asset_url=$(echo "$asset" | jq -r '.url')
              asset_size=$(echo "$asset" | jq -r '.size')

              echo "ä¸‹è½½èµ„æº: $asset_name (å¤§å°: $asset_size bytes)"
              safe_filename="./temp_download_$(date +%s)_$j"

              # ä¸‹è½½
              curl -sL -o "$safe_filename" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/octet-stream" \
                "$asset_url" || {
                echo "âŒ ä¸‹è½½å¤±è´¥: $asset_name"
                continue
              }

              # å¤§å°æ ¡éªŒ
              actual_size=$(wc -c < "$safe_filename")
              [ "$actual_size" -ne "$asset_size" ] && {
                echo "âŒ æ–‡ä»¶å¤§å°ä¸åŒ¹é…: $asset_name"
                rm -f "$safe_filename"
                continue
              }

              # ç»„è£…è¿œç¨‹è·¯å¾„ï¼ˆURL ç¼–ç ï¼‰
              remote_path="$ALIST_DIR/$tag_name/$asset_name"
              file_path_encoded=$(printf %s "$remote_path" | jq -sRr @uri)
              echo "ä¸Šä¼ åˆ° Alist: $remote_path"

              # è°ƒç”¨ /api/fs/put ä¸Šä¼ ï¼ˆå¸¦ As-Task å¼‚æ­¥ï¼‰
              response=$(
                curl -s -X PUT "$ALIST_URL/api/fs/put" \
                  -H "Authorization: $token" \
                  -H "File-Path: $file_path_encoded" \
                  -H "Content-Type: application/octet-stream" \
                  -H "Content-Length: $actual_size" \
                  -H "As-Task: true" \
                  --data-binary @"$safe_filename"
              )
              echo "==== ä¸Šä¼ æ¥å£åŸå§‹è¿”å› ===="
              echo "$response"
              code=$(echo "$response" | jq -r '.code // empty')
              if [ "$code" = "200" ]; then
                echo "âœ… Alist ä¸Šä¼ ä»»åŠ¡åˆ›å»ºæˆåŠŸ: $asset_name"
              else
                echo "âŒ Alist ä¸Šä¼ å¤±è´¥: $asset_name"
              fi

              rm -f "$safe_filename"
              echo "----------------------------------------"
            done
            echo "ç‰ˆæœ¬ $tag_name å¤„ç†å®Œæˆ"
            echo "========================================"
          done

          # ========== 5. é€€å‡ºç™»å½• ==========
          echo "é€€å‡ºç™»å½• ..."
          curl -s -X POST "$ALIST_URL/api/auth/logout" \
            -H "Authorization: $token" > /dev/null || true

          echo "ğŸ‰ Alist åŒæ­¥å®Œæˆ"

      - name: Summary
        run: |
          echo "åŒæ­¥ä»»åŠ¡å·²å®Œæˆï¼"
          echo "è¯·æ£€æŸ¥ Alist ä¸­çš„æ–‡ä»¶æ˜¯å¦æ­£ç¡®ä¸Šä¼ ã€‚"
          echo "å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š"
          echo "1. ALIST_URL      - Alist æœåŠ¡å™¨åœ°å€"
          echo "2. ALIST_USERNAME - Alist ç™»å½•è´¦å·"
          echo "3. ALIST_PASSWORD - Alist ç™»å½•å¯†ç "
          echo "4. GITHUB_TOKEN   - GitHub è®¿é—®ä»¤ç‰Œ"

# 桌面歌词

## 打开/隐藏与锁定

- 打开/隐藏：通过设置开关或系统托盘菜单切换桌面歌词窗口的显示状态。
  - 托盘菜单与 IPC：`src/main/index.ts:51-97`、`src/main/events/lyric.ts:32-49`。
- 锁定穿透：锁定后窗口忽略鼠标事件，可穿透点击桌面或其他应用。
  - 锁定/解锁处理与状态广播：`src/main/events/lyric.ts:138-155`。

## 窗口与渲染

- 窗口创建：透明置顶、可拖拽、可缩放，加载 `lyric.html` 作为渲染页面。
  - 窗口参数与加载：`src/main/windows/lyric-window.ts:28-66`。
- 渲染页面：响应 IPC 事件更新歌词、索引与样式；支持拖拽移动与高度自适应。
  - 事件监听与拖拽：`src/web/lyric.html:710-784`。

## 样式配置

- 设置 → 桌面歌词样式：字号、主色、阴影实时预览；切换显示开关。
  - UI：`src/renderer/src/components/Settings/DesktopLyricStyle.vue:153`。
- 主进程保存与广播：保存样式配置并回传给歌词窗口与主窗口，保持两端状态一致。
  - 配置持久化与广播：`src/main/events/lyric.ts:116-135`。

## 歌词数据来源与解析

- 数据来源：优先 TTML（若有）否则 CR/QRC/LRC；支持翻译合并与时间轴计算。
  - 桥接逻辑：`src/renderer/src/utils/lyrics/desktopLyricBridge.ts:78-179`。
- 索引计算：根据当前播放时间（毫秒）定位当前行，并在 30% 进度时切换前后行渲染。
  - 索引计算与进度广播：`src/renderer/src/utils/lyrics/desktopLyricBridge.ts:20-40`、`src/renderer/src/utils/lyrics/desktopLyricBridge.ts:181-229`。

